
\section{Modeling}

\subsection {Semiparametric Proportional Hazards Model}

For semiparametric proportional hazards model, we proceed as follows:

The variable \textit{size} is a categorical variable with 3 levels. We recode the levels Size ($20-50$) and Size ($>50$) as binary variables, and take the level Size ($\leq20$) as reference level.
We then estimate the full model, only excluding variables \textit{rtime} and \textit{recur}, since they are not the chosen event of interest.


```{r message=FALSE, warning=FALSE, include=FALSE}
library(KMsurv)
library(MASS)

##fitting full model

fit_ph1 <-
  coxph(
    Surv(dtime, as.numeric(death)) ~ chemo + meno + hormon + as.factor(size) +
      age + as.factor(grade) + nodes + pgr + er,
    data = data
  )

##Backward variable selection based on p-value
anova(fit_ph1)
fit_ph2 <-
  coxph(
    Surv(dtime, as.numeric(death)) ~ chemo + meno + hormon + as.factor(size) +
      age + as.factor(grade) + nodes + pgr,
    data = data
  )
anova(fit_ph2)
fit_ph3<-coxph(Surv(dtime,as.numeric(death))~meno+hormon+as.factor(size)+age+as.factor(grade)+nodes +pgr, data=data,ties = "efron")
anova(fit_ph3)
#all variables in fit_ph3 is significant

#variable selection based on AIC
#stepAIC <- stepAIC(fit_ph1,direction="both")

#chosen model:Surv(dtime, death) ~ as.factor(size) + age + 
   # as.factor(grade) + nodes + pgr

fit_ph_aic= coxph(formula = Surv(dtime, as.numeric(death)) ~ as.factor(size) + age + 
    as.factor(grade) + nodes + pgr , data = data)
summary(fit_ph_aic)

AIC = c(extractAIC(fit_ph_aic)[2], extractAIC(fit_ph3)[2])
names(AIC) = c("Stepwise AIC","Backward Selection" )
fit_ph_final <- fit_ph3
```

```{r AIC-table, echo=FALSE, message=FALSE, warning=FALSE}
AIC.table <- rbind(AIC)
rownames(AIC.table) <- "AIC"

kbl(AIC.table, 
    escape = FALSE, booktabs = T,
    caption = "AIC values for models selected by stepwise AIC procedure, and backward selection procedure. ") %>%
  kable_styling(font_size = 10, latex_options = c("striped", "hold_position"))
```

For model selection with all covariates, we first fit a full model to apply backward selection procedure. By excluding the covariate with the largest p-value in each iteration, we ended up with the model where significant covariates are \textit{size, age, grade, nodes, pgr, meno, hormon}.

Next, we run stepwise AIC selection in both directions. This resulted with the model where significant covariates are \textit{size, age, grade, nodes, pgr}. 

To decide which procedure should be used to choose the model, we approach from 2 different points. From a logical point of view, the model including hormonal treatment is reasonable since it might have a direct influence on survival time. If we compare AIC of both models, from Table \@ref(tab:AIC-table) we see that there is no huge difference (`r round(AIC[1])` and `r round(AIC[2])`, respectively). So we decide to go with the model selected based on p-value since it includes hormon in exchange of acceptable increase in AIC.


```{r echo=FALSE, message=FALSE, warning=FALSE}
##CI for HR of size>50 vs size20-50
covmat <- vcov(fit_ph_final)
e <- exp(fit_ph_final$coefficients['as.factor(size)>50']) /
     exp(fit_ph_final$coefficients['as.factor(size)20-50'])
ub <- exp(fit_ph_final$coefficients['as.factor(size)>50'] -
          fit_ph_final$coefficients['as.factor(size)20-50'] -
          qnorm(0.025) * sqrt(covmat['as.factor(size)>50',
                                     'as.factor(size)>50'] +
                              covmat['as.factor(size)20-50',
                                     'as.factor(size)20-50'] -
                              2 *
                              covmat['as.factor(size)20-50',
                                     'as.factor(size)>50']))
lb <- exp(fit_ph_final$coefficients['as.factor(size)>50'] -
          fit_ph_final$coefficients['as.factor(size)20-50'] +
          qnorm(0.025) * sqrt(covmat['as.factor(size)>50',
                                     'as.factor(size)>50'] +
                              covmat['as.factor(size)20-50',
                                     'as.factor(size)20-50'] -
                                2 *
                              covmat['as.factor(size)20-50',
                                     'as.factor(size)>50']))
ci <- c(e, lb, ub)
names(ci) <- c("est", "lb", "ub")

### Q: Do we have tied observations??

fit.ph.table <- summary(fit_ph_final)$conf[, c(1, 3, 4)]
fit.ph.table <- rbind(fit.ph.table, ci)
row.names(fit.ph.table) <- c("Meno = 1 vs Meno = 0",
                             "Hormon = 1 vs Hormon = 0",
                             "Size $20-50$ vs Size $\\leq$ 20",                              
                             "Size $>$50 vs Size $\\leq$ 20",
                             "Age",
                             "Grade = 3 vs Grade = 2",
                             "Nodes",
                             "Pgr",
                             "Size $>$50 vs Size $20-50$")
colnames(fit.ph.table) <-  c("HR", 
                             "5$%$", 
                             "95$%$")
```

```{r relative-risks-tbl, echo=FALSE, message=FALSE, warning=FALSE}
kbl(fit.ph.table,
    escape = FALSE, booktabs = T,
    caption = "Relative Risks and CI for each covariate") %>%
  kable_styling(font_size = 10,
                latex_options = c("striped", "hold_position"))
```



Estimation and CI of relative risks for every pair of levels of the
categorical variables are as below: HR of chemo vs non-chemo: 1.0423
with 95%CI [0.91353 1.18914] HR of meno vs non-meno: 0.8160 with 95%CI
[0.69415 0.95916] HR of hormon treatment vs no treatment: 1.7815 with
95%CI [0.69415 0.95916] HR of size20-50 vs size\<=20: 0.8650 with 95%CI
[0.78503 0.95308] HR of size\>50 vs size\<=20: 0.9678 with 95%CI
[0.79736 1.17457] HR of size\>50 vs size20-50:
exp(Beta(size\>50)-Beta(size20-50))={exp(fit_ph4$coefficients['as.factor(size)>50'])/exp(fit_ph4$coefficients['as.factor(size)20-50'])}=1.118818
with 95%CI [??] HR of age i vs age i-1: 1.0075 with 95%CI [1.00110
1.01387] HR of grade 3 vs grade 2: 1.0575 with 95%CI [0.95655 1.16910]
HR of recur vs non-recur: 0.0131 with 95%CI [0.01043 0.01646] HR of
rtime i vs rtime i-1: 0.9985 with 95%CI [0.99841 0.99854]

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Test for assumption of constant HR 
test <- cox.zph(fit_ph_final)$table
kbl(test, booktabs = T, caption = "Proportional Hazard Test") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

We run a statistical test based on Schoenfeld residuals for proportional
hazard assumption for each covariate included in the Cox fit. From the
output, one can see that test is statistically significant for some
covariates like age, pgr, and meno with nodes and grade being a borderline case.  The global test is also significant.
So we can state that proportional hazard assumption is violated since
there is significant dependency between Schoenfeld residuals and time.

\subsection {Parametric Regression Models}

```{r}
library(KMsurv)
library(survival)
logn = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="lognormal")
weib = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="weibull")
expon = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="exponential")
loglogist = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="loglogistic")

AIC = c(extractAIC(logn)[2], extractAIC(weib)[2], extractAIC(expon)[2], extractAIC(loglogist)[2])
names(AIC) = c("log(normal)", "weibull", "exponential", "log(logistic)")
AIC <- as.data.frame(AIC)

kbl(AIC, booktabs = T, caption = "Parametric Model Evaluation") %>%
  kable_styling(latex_options = c("striped", "hold_position")) 

log.normal <- AIC["log(normal)",1]
```

We first evaluate parametric models based on variables already selected in the previous section.  Here we are comparing log (normal), weibull, exponential, and log (logistic) distributions.  This is done by using AIC and identifying if the additional parameters are worth it.  What we see is that the log(normal) distribution has the best AIC at `r log.normal`.  It should be noted that these AIC values can not be directly compared to the semi-parametric values.  We are able to estimate the linear coefficients to be the negative of the log(normal) coefficients due to the normality of this distribution.  These can be see in Table 12.

```{r CoefficientComparison}
# Linear model predictors
library(broom)

bestModel <- logn
tidyModel <- tidy(bestModel, type = 'text')
tidyModel <- head(tidyModel, nrow(tidyModel)-1)
linCoeffs <- c(-bestModel$coefficients)
tidyModel <- cbind(round(tidyModel[,2:(ncol(tidyModel)-1)], 2), tidyModel[,ncol(tidyModel)])
table <- cbind(tidyModel, round(confint(bestModel), 2), round(linCoeffs, 2))
colnames(table)[7] <- "Linear Coefficient"

kbl(table, booktabs = T, caption = "Parametric Model Coefficient Comparison") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


When we look at our categorical variable, hormon, it is significant and the confidence interval confirms this as it does not contain 0.  However, it should be noted that this is a borderline case.

