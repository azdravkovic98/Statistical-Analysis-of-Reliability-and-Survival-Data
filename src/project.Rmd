---
documentclass: article
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    includes:
      in_header: preamble.sty
      before_body: titlepage.sty
    toc: false
bibliography: bibliography.bib
link-citations: true
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
options(knitr.kable.NA = '')
knitr::opts_chunk$set(echo = FALSE, fig.pos = "!H", out.extra = "")
```

\section{Exploratory Data Analysis}

These data sets are used in the paper by Royston and Altman that is
referenced below. The Rotterdam data is used to create a fitted model,
and the GBSG data for validation of the model. The paper gives
references for the data source.

There are 43 subjects who have died without recurrence, but whose death
time is greater than the censoring time for recurrence. A common way
that this happens is that a death date is updated in the health record
sometime after the research study ended, and said value is then picked
up when a study data set is created. But it raises serious questions
about censoring. For instance subject 40 is censored for recurrence at
4.2 years and died at 6.6 years; when creating the endpoint of
recurrence free survival (earlier of recurrence or death), treating them
as a death at 6.6 years implicitly assumes that they were recurrence
free just before death. For this to be true we would have to assume that
if they had progressed in the 2.4 year interval before death (while off
study), that this information would also have been noted in their
general medical record, and would also be captured in the study data
set. However, that may be unlikely. Death information is often in a
centralized location in electronic health records, easily accessed by a
programmer and merged with the study data, while recurrence may require
manual review. How best to address this is an open issue.

```{r message=FALSE, warning=FALSE}
library(survival)
data <- rotterdam
library(tidyverse)
data$death <- as.factor(data$death)
data$meno <- as.factor(data$meno)
data$size <- as.factor(data$size)
data$grade <- as.factor(data$grade)
data$hormon <- as.factor(data$hormon)
data$chemo <- as.factor(data$chemo)
data$recur <- as.factor(data$recur)
```

```{r data-desc, echo=FALSE, message=FALSE, warning=FALSE, fig.pos="H"}
library(kableExtra)
library(glue)
table <- rbind(c("pid", "Patient identifier"), 
               c("year", "Year of surgery"),
               c("age", "Age at surgery"), 
               c("meno", "Menopausal status (0 = premenopausal, 1 = postmenopausal)"), 
               c("size", "Tumor size, a factor with levels <= 20, 20-25, > 50"), 
               c("grade", "Differentiation grade"), 
               c("nodes", "Number of positive lymph nodes"), 
               c("pgr", "Progesterone receptors (fmol/l)"), 
               c("er", "Estrogen receptors (fmol/l)"),
               c("hormon", "Hormonal treatment (0=no, 1=yes)"),
               c("chemo", "Chemotherapy"),
               c("rtime", "Days to relapse or last follow-up"),
               c("recur","0 = no relapse, 1 = relapse"),
               c("dtime","Days to death or last follow-up"),
               c("death","0 = alive, 1 = dead"))
kbl(table, booktabs = T, caption = "Data description") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Table \@ref(tab:data-desc) explains the covariates in the Rotterdam
dataset.


When we investigate the categorical variables, we see that some have a larger difference between time until death than others.  When we first investigate menopause, we see that menopausal patients are very similar in their death time.  A very similar pattern is observed for chemotherapy but the patients that did not die had a slightly higher time before leaving the study.  While size, having three levels, needs to be interpreted slightly differently.  With patients that died, the larger cancer cells certainly caused it to happen sooner.  This makes intuitive sense that more severe cancer would have more long term health risks.  Among patients that do not die, only the extremely large cancer patients had a much lower death time.  While small and medium patients had a very similar response.  Grade had a very similar response among all patients with higher grade patients living slightly shorter lives.  Patients given hormonal therapy seem to have a smaller tail among patients that died; meaning those who died are more likely to do it soon after treatment.  Surviving patients that had hormonal therapy also appear to be censored more quickly than those who do not receive the treatment.

```{r boxPlots, include=TRUE, message = FALSE, fig.show = "hold", out.width = "50%"}
library(ggplot2)
menoBox <- ggplot(data, aes(x = death, y = dtime, fill=death, linetype=meno,colour=meno)) + geom_boxplot(lwd=0.75)+ scale_fill_manual(values=c("darkgreen", "darkred")) + scale_colour_manual(values=c("black","black"))

chemoBox <- ggplot(data, aes(x = death, y = dtime, fill=death, linetype=chemo,colour=chemo)) + geom_boxplot(lwd=0.75)+ scale_fill_manual(values=c("darkgreen", "darkred")) + scale_colour_manual(values=c("black","black"))

sizeBox <- ggplot(data, aes(x = death, y = dtime, fill=death, linetype=size,colour=size)) + geom_boxplot(lwd=0.75)+ scale_fill_manual(values=c("darkgreen", "darkred")) + scale_colour_manual(values=c("black","black","black"))

gradeBox <- ggplot(data, aes(x = death, y = dtime, fill=death, linetype=grade,colour=grade)) + geom_boxplot(lwd=0.75)+ scale_fill_manual(values=c("darkgreen", "darkred")) + scale_colour_manual(values=c("black","black"))

hormonBox <- ggplot(data, aes(x = death, y = dtime, fill=death, linetype=hormon,colour=hormon)) + geom_boxplot(lwd=0.75)+ scale_fill_manual(values=c("darkgreen", "darkred")) + scale_colour_manual(values=c("black","black"))

plot(menoBox)
plot(chemoBox)
plot(sizeBox)
plot(gradeBox)
plot(hormonBox)
```



Among continuous variables, we first investigated age.  We plotted a both the lowess curve and the linear model to see if they match.  If so, they most likely have data with a limited skew and do not require transformation for modeling.  We first evaluated age and there was not a difference between the linear and lowess curves.  Next, we investigated the relationship between er and death time.  Here we see a large deviation which was corrected for again with a log transform.  Finally, we evaluated pgr and it had a good fit overall.



```{r scatterPlots, include=TRUE, message=FALSE, warning=FALSE, fig.show = "hold", out.width = "50%"}

# Basic age
ggplot(data, aes(x = age, y = dtime, color = death)) +
  geom_point() + geom_smooth(formula='y ~ x', method="loess",size=2, se=FALSE) + 
  geom_smooth(formula='y ~ x', method="lm",size=2, se=FALSE) + scale_color_manual(values=c("darkgreen", "red"))

# er
ggplot(data, aes(x = er, y = dtime, color = death)) +
  geom_point() + geom_smooth(formula='y ~ x', method="loess",size=2, se=FALSE) + 
  geom_smooth(formula='y ~ x', method="lm",size=2, se=FALSE) + scale_color_manual(values=c("darkgreen", "red"))

# log(er)
ggplot(data, aes(x = log(er), y = dtime, color = death)) +
  geom_point() + geom_smooth(formula='y ~ x', method="loess",size=2, se=FALSE) + 
  geom_smooth(formula='y ~ x', method="lm",size=2, se=FALSE) + scale_color_manual(values=c("darkgreen", "red"))

ggplot(data, aes(x = pgr, y = dtime, color = death)) +
  geom_point() + geom_smooth(formula='y ~ x', method="loess",size=2, se=FALSE) + 
  geom_smooth(formula='y ~ x', method="lm",size=2, se=FALSE) + scale_color_manual(values=c("darkgreen", "red"))

```


\section{Further Analysis}

Now the focus will be on the response variable, the censoring indicator,
and the categorical variable.

\subsection{Survival Distrubution by Levels of ...}

(a) For each of the levels of the categorical variable, compute the
    survival distribution. Plot them on the same graph. What do the
    graphs suggest?

\subsubsection{Size}

```{r message=FALSE, warning=FALSE, include=FALSE}
fit.size <- survfit(Surv(dtime, as.numeric(death)) ~ size, data = data)
```

```{r message=FALSE, warning=FALSE}
#install.packages("survminer")
library(survminer)
ggsurvplot(fit.size,
           pval = TRUE, conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata", # Change risk table color by groups
           linetype = "strata", # Change line type by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           palette = c("#E7B800", "#2E9FDF", "maroon2"), 
           data = data)
```

The horizontal axis represents time in days, and the vertical axis shows
the probability of surviving, or the proportion of people surviving. The
lines represent survival curves of the three groups. A vertical drop in
the curves indicates an event. The vertical tick mark on the curves
means that a patient was censored at this time.


```{r median-size, echo=FALSE, message=FALSE, warning=FALSE}
fit.size.table <- summary(fit.size)$table
rownames(fit.size.table) <- c("Size ($\\leq$20)", "Size (20$-$50)", "Size ($>$50)")
#colnames(fit.size.table) <- c()

kbl(fit.size.table, 
    escape = FALSE, booktabs = T,
    caption = "Summary of the model.") %>%
  kable_styling(font_size = 8, latex_options = c("striped", "hold_position"))
```

At time zero, the survival probability is 1.0 (or 100% of the participants are alive). At time 2250, the probability of survival is approximately 0.625 for size\>=50, and 0.85 for size\<50. 

From Table \@ref(tab:median-size) can be seen that the median survival for Size \geq 50 is `r fit.size.table[, 'median'][1]`, for Size  20-50 is `r fit.size.table[, 'median'][2]`, and for Size \> 50 is `r fit.size.table[, 'median'][3]`. This suggests worse survival for patients with tumor of larger size. However, to evaluate whether this difference is statistically significant requires a formal statistical test, a subject that is discussed in the next sections.

\subsubsection{Menopause}

```{r message=FALSE, warning=FALSE}
fit.meno <- survfit(Surv(dtime, as.numeric(death)) ~ meno, data = data)
```

```{r message=FALSE, warning=FALSE}
ggsurvplot(fit.meno,
           pval = TRUE, conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata", # Change risk table color by groups
           linetype = "strata", # Change line type by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           palette = c("#E7B800", "#2E9FDF"), 
           data = data)
```

```{r median-meno, include=TRUE, message = FALSE}
fit.meno.table <- summary(fit.meno)$table
rownames(fit.meno.table) <- c("Meno = 0", "Meno = 1")
#colnames(fit.meno.table) <- c()

kbl(fit.meno.table, 
    escape = FALSE, booktabs = T,
    caption = "Median survival times for each group.") %>%
  kable_styling(font_size = 8, latex_options = c("striped", "hold_position"))
```



At time zero, the survival probability is 1.0 (or 100% of the
participants are alive). At time 2200, the probability of survival is
approximately 0.75 for non-menopausal patients, and 0.825 for
menopausal patients.

From Table \@ref(tab:median-meno) can be seen that the median survival is `r fit.meno.table[,'median'][1]` for non-menopausal patients, and `r fit.meno.table[,'median'][2]` for menopausal, suggesting worse survival for patients that have gone through
menopause.

\subsubsection{Hormonal Treatment}

```{r message=FALSE, warning=FALSE}
fit.hormon <- survfit(Surv(dtime, as.numeric(death)) ~ hormon, data = data)
```

```{r message=FALSE, warning=FALSE}
ggsurvplot(fit.hormon,
           pval = TRUE, conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata", # Change risk table color by groups
           linetype = "strata", # Change line type by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           palette = c("#E7B800", "#2E9FDF"), 
           data = data)
```

```{r median-hormon, include=TRUE, message = FALSE}
fit.hormon.table <- summary(fit.hormon)$table
kable(fit.hormon.table, 
      caption = "Median survival times for each group.") %>%
kable_styling(font_size = 8, latex_options = c("striped", "hold_position"))
```

At time zero, the survival probability is 1.0 (or 100% of the
participants are alive). At time 2200, the probability of survival is
approximately 0.75 for premenopausal patients, and 0.825 for
postmenopausal patients.

From Table \@ref(tab:median-hormon) can be seen that the median survival is `r fit.hormon.table[,'median'][1]` for patients that went through hormonal therapy, and `r fit.hormon.table[,'median'][2]` for those who did not, suggesting slightly worse survival for patients that have gone through the hormonal therapy. However, to evaluate whether this difference is statistically significant requires a formal statistical test, a subject that is discussed in the next sections.

\subsubsection{Chemotherapy}

```{r message=FALSE, warning=FALSE}
fit.chemo <- survfit(Surv(dtime, as.numeric(death)) ~ chemo, type="kaplan-meier", data = data)
```


```{r message=FALSE, warning=FALSE}
ggsurvplot(fit.chemo,
           pval = TRUE, conf.int = TRUE,
           risk.table = TRUE, # Add risk table
           risk.table.col = "strata", # Change risk table color by groups
           linetype = "strata", # Change line type by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           palette = c("#E7B800", "#2E9FDF"), 
           data = data)
```

```{r median-chemo, include=TRUE, message = FALSE}
fit.chemo.table <- summary(fit.chemo)$table
kable(fit.chemo.table, 
      caption = "Median survival times for each group.") %>%
kable_styling(font_size = 8, latex_options = c("striped", "hold_position"))
```

At time zero, the survival probability is 1.0 (or 100% of the
participants are alive). At time 2200, the probability of survival is
approximately 0.75 for premenopausal patients, and 0.825 for
postmenopausal patients.

From Table \@ref(tab:median-chemo) can be seen that the median survival is `r fit.hormon.table[,'median'][1]` for patients that went through hormonal therapy, and `r fit.hormon.table[,'median'][2]` for those who did not, suggesting slightly better survival for patients that have gone through chemotherapy. However, to evaluate whether this difference is statistically significant requires a formal statistical test, a subject that is discussed in the next sections.


\subsection{Confidence Intervals and Estimators by Levels of ...}


(b) For each level obtain an appropriate estimator and confidence
    interval for the 3 quartiles of the survival curves. Interpret the
    results.

```{r quantiles-size, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)

quantile.size <- quantile(fit.size, conf.int = TRUE)$quantile
quantile.size.lower <- quantile(fit.size, conf.int = TRUE)$lower
quantile.size.upper <- quantile(fit.size, conf.int = TRUE)$upper

quantile25 <- quantile.size[, "25"]
quantile25.lower <- quantile.size.lower[, "25"]
quantile25.upper <- quantile.size.upper[, "25"]

quantile50 <- quantile.size[, "50"]
quantile50.lower <- quantile.size.lower[, "50"]
quantile50.upper <- quantile.size.upper[, "50"]

quantile75 <- quantile.size[, "75"]
quantile75.lower <- quantile.size.lower[, "75"]
quantile75.upper <- quantile.size.upper[, "75"]

quantile.size.table <- data.frame(quantile25,
                                  quantile25.lower,
                                  quantile25.upper,
                                  quantile50,
                                  quantile50.lower,
                                  quantile50.upper,
                                  quantile75,
                                  quantile75.lower,
                                  quantile75.upper)
rownames(quantile.size.table) <- c("Size ($\\leq$50)" ,"Size (20$-$50)", "Size ($>$50)")
names(quantile.size.table)[1] <- "$\\hat{q_1}$"
names(quantile.size.table)[2] <- "5\\%"
names(quantile.size.table)[3] <- "95\\%"
names(quantile.size.table)[4] <- "$\\hat{q_2}$"
names(quantile.size.table)[5] <- "5\\%"
names(quantile.size.table)[6] <- "95\\%"
names(quantile.size.table)[7] <- "$\\hat{q_3}$"
names(quantile.size.table)[8] <- "5\\%"
names(quantile.size.table)[9] <- "95\\%"

```

```{r quantiles-meno, echo=FALSE, message=FALSE, warning=FALSE}
quantile.meno <- quantile(fit.meno, conf.int = TRUE)$quantile
quantile.meno.lower <- quantile(fit.meno, conf.int = TRUE)$lower
quantile.meno.upper <- quantile(fit.meno, conf.int = TRUE)$upper

quantile25 <- quantile.meno[, "25"]
quantile25.lower <- quantile.meno.lower[, "25"]
quantile25.upper <- quantile.meno.upper[, "25"]

quantile50 <- quantile.meno[, "50"]
quantile50.lower <- quantile.meno.lower[, "50"]
quantile50.upper <- quantile.meno.upper[, "50"]

quantile75 <- quantile.meno[, "75"]
quantile75.lower <- quantile.meno.lower[, "75"]
quantile75.upper <- quantile.meno.upper[, "75"]

quantile.meno.table <- data.frame(quantile25,
                                  quantile25.lower,
                                  quantile25.upper,
                                  quantile50,
                                  quantile50.lower,
                                  quantile50.upper,
                                  quantile75,
                                  quantile75.lower,
                                  quantile75.upper)
rownames(quantile.meno.table) <- c("Meno = 0" ,"Meno = 1")
names(quantile.meno.table)[1] <- "$\\hat{q_1}$"
names(quantile.meno.table)[2] <- "5\\%"
names(quantile.meno.table)[3] <- "95\\%"
names(quantile.meno.table)[4] <- "$\\hat{q_2}$"
names(quantile.meno.table)[5] <- "5\\%"
names(quantile.meno.table)[6] <- "95\\%"
names(quantile.meno.table)[7] <- "$\\hat{q_3}$"
names(quantile.meno.table)[8] <- "5\\%"
names(quantile.meno.table)[9] <- "95\\%"


```


```{r quantiles-hormon, echo=FALSE, message=FALSE, warning=FALSE}
quantile.hormon <- quantile(fit.hormon, conf.int = TRUE)$quantile
quantile.hormon.lower <- quantile(fit.hormon, conf.int = TRUE)$lower
quantile.hormon.upper <- quantile(fit.hormon, conf.int = TRUE)$upper

quantile25 <- quantile.hormon[, "25"]
quantile25.lower <- quantile.hormon.lower[, "25"]
quantile25.upper <- quantile.hormon.upper[, "25"]

quantile50 <- quantile.hormon[, "50"]
quantile50.lower <- quantile.hormon.lower[, "50"]
quantile50.upper <- quantile.hormon.upper[, "50"]

quantile75 <- quantile.hormon[, "75"]
quantile75.lower <- quantile.hormon.lower[, "75"]
quantile75.upper <- quantile.hormon.upper[, "75"]

quantile.hormon.table <- data.frame(quantile25,
                                  quantile25.lower,
                                  quantile25.upper,
                                  quantile50,
                                  quantile50.lower,
                                  quantile50.upper,
                                  quantile75,
                                  quantile75.lower,
                                  quantile75.upper)
rownames(quantile.hormon.table) <- c("Hormon = 0" ,"Hormon = 1")
names(quantile.hormon.table)[1] <- "$\\hat{q_1}$"
names(quantile.hormon.table)[2] <- "5\\%"
names(quantile.hormon.table)[3] <- "95\\%"
names(quantile.hormon.table)[4] <- "$\\hat{q_2}$"
names(quantile.hormon.table)[5] <- "5\\%"
names(quantile.hormon.table)[6] <- "95\\%"
names(quantile.hormon.table)[7] <- "$\\hat{q_3}$"
names(quantile.hormon.table)[8] <- "5\\%"
names(quantile.hormon.table)[9] <- "95\\%"


```


```{r quantiles-chemo, echo=FALSE, message=FALSE, warning=FALSE, fig.pos="H"}
quantile.chemo <- quantile(fit.chemo, conf.int = TRUE)$quantile
quantile.chemo.lower <- quantile(fit.chemo, conf.int = TRUE)$lower
quantile.chemo.upper <- quantile(fit.chemo, conf.int = TRUE)$upper

quantile25 <- quantile.chemo[, "25"]
quantile25.lower <- quantile.chemo.lower[, "25"]
quantile25.upper <- quantile.chemo.upper[, "25"]

quantile50 <- quantile.chemo[, "50"]
quantile50.lower <- quantile.chemo.lower[, "50"]
quantile50.upper <- quantile.chemo.upper[, "50"]

quantile75 <- quantile.chemo[, "75"]
quantile75.lower <- quantile.chemo.lower[, "75"]
quantile75.upper <- quantile.chemo.upper[, "75"]

quantile.chemo.table <- data.frame(quantile25,
                                  quantile25.lower,
                                  quantile25.upper,
                                  quantile50,
                                  quantile50.lower,
                                  quantile50.upper,
                                  quantile75,
                                  quantile75.lower,
                                  quantile75.upper)
rownames(quantile.chemo.table) <- c("Chemo = 0" ,"Chemo = 1")
names(quantile.chemo.table)[1] <- "$\\hat{q_1}$"
names(quantile.chemo.table)[2] <- "5\\%"
names(quantile.chemo.table)[3] <- "95\\%"
names(quantile.chemo.table)[4] <- "$\\hat{q_2}$"
names(quantile.chemo.table)[5] <- "5\\%"
names(quantile.chemo.table)[6] <- "95\\%"
names(quantile.chemo.table)[7] <- "$\\hat{q_3}$"
names(quantile.chemo.table)[8] <- "5\\%"
names(quantile.chemo.table)[9] <- "95\\%"


table <- rbind(quantile.size.table,
               quantile.chemo.table,
               quantile.meno.table,
               quantile.hormon.table)
table <- round(table)
quantile.chemo.table[is.na(quantile.chemo.table)] <- "$\\textit{NA}$"
quantile.size.table[is.na(quantile.size.table)] <- "$\\textit{NA}$"
quantile.hormon.table[is.na(quantile.hormon.table)] <- "$\\textit{NA}$"
quantile.meno.table[is.na(quantile.meno.table)] <- "$\\textit{NA}$"
table[is.na(table)] <- "$\\textit{NA}$"

kbl(table,
    escape = FALSE, booktabs = T,
    caption = "Estimates and confidence intervals for 3 quartiles for each level of covariates $\\textit{size, chemo, meno, hormon}$.") %>%
  kable_styling(font_size = 10, latex_options = c("striped", "hold_position"))
```

We first evaluate size and see similar results to what was observed in the EDA barcharts. We see that at the 25th percentile, size >50 has a very significant difference from the other two groups.  With this being significantly smaller, their dtime is significantly smaller.  This intuitively makes sense that a person who has larger cancer would have a worse life expectancy.  However, this phenomenon has faded by the 50th percentile and persists through the 75th.  This means that if a person survives the initial hurdle after surgery, they are not expected to be significantly different from the rest of the population.


When we investigate the effect of menopause on survival, we see that generally people that are menopausal have lower survival times.  This is supported by that at the 25th, 50th, and 75th percentiles, there is no overlap in the quantiles' confidence intervals.  This means that at all stages, a menopausal person would have a shorter life.  However, this could be due to other covariates such as the fact that all menopausal people are women or that they tend to be older.



We next evaluate the effect of hormonal treatment.  We see here that those who received hormonal treatment generally have a lower survival time.  We also see that there is no overlap between the confidence intervals indicating that not only did they have a large difference, but it sustained itself throughout the entire distribution of patients.


Finally, we evaluate the effect of chemotherapy.  Here we see that generally chemotherapy patients live longer.  However, this only becomes significant at the 75th percentile.  This means that generally patients that receive chemotherapy are not significantly affected until they live for a long time.


\subsection{Test of Differences Between the Survival Curves}

(c) Conduct a single test of differences between the survival curves.
    Justify your choice of test.
    
```{r stratify, echo=FALSE, message=FALSE, warning=FALSE}
# Stratification by size
stratify.size <- survdiff(Surv(dtime, as.numeric(death)) ~ meno + strata(size), 
                          data = data)

chisq.size <- stratify.size$chisq
df.size <- length(stratify.size$n) - 1
p.size <- 1 - pchisq(stratify.size$chisq, 
                     length(stratify.size$n) - 1)
by.size <- c(round(chisq.size, 2), round(df.size), p.size)

# Stratification by age
stratify.age <- survdiff(Surv(dtime, as.numeric(death)) ~ meno + strata(age), 
                          data = data)

chisq.age <- stratify.age$chisq
df.age <- length(stratify.age$n) - 1
p.age <- 1 - pchisq(stratify.age$chisq, 
                    length(stratify.age$n) - 1)
by.age <- c(round(chisq.age, 2), round(df.age), p.age)


# Stratification by hormon
stratify.hormon <- 
  survdiff(Surv(dtime, as.numeric(death)) ~ meno + strata(hormon), 
           data = data)

chisq.hormon <- stratify.hormon$chisq
df.hormon <- length(stratify.hormon$n) - 1
p.hormon <- 1 - pchisq(stratify.hormon$chisq, 
                       length(stratify.hormon$n) - 1)
by.hormon <- c(round(chisq.hormon, 2), round(df.hormon), p.hormon)

table <- rbind(by.age, by.size, by.hormon)
rownames(table) <- c("Stratified by Age", 
                     "Stratified by Size", 
                     "Stratified by Hormon")
colnames(table) <- c("$\\chi^2$", "df", "p-value")

kbl(table, 
    escape = FALSE, booktabs = T,
    caption = "Stratified log-rank test for differences in menopause.") %>%
  kable_styling(font_size = 10, latex_options = c("striped", "hold_position"))

```

```{r message=FALSE, warning=FALSE, include=FALSE}
stratify.size.fit <- survfit(Surv(dtime, as.numeric(death)) ~ meno + strata(size), 
                             data = data,
                             type="kaplan-meier", 
                             conf.type="log-log")
```


```{r stratify-size-plot, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Independent variable meno stratified by size of the tumor.", fig.pos="H"}
ggsurvplot(stratify.size.fit,       # survfit object with calculated statistics.
           pval = TRUE,             # show p-value of log-rank test.
           conf.int = TRUE,        # show confidence intervals for point estimates of survival curves.
           conf.int.style = "step",  # customize style of confidence intervals
           xlab = "Time in days",   # customize X axis label.
           break.time.by = 1500,     # break X axis in time intervals by ...
           ggtheme = theme_light(), # customize plot and risk table with a theme.
           surv.median.line = "hv",  # add the median survival pointer.
           #palette = c("#E7B800", "#2E9FDF", "maroon2"), # custom color palettes.
           data = data,
           xlim = c(0, 6500))
```


In this setting we chose to use the log-rank test.  This is because we do not want to weight any observations more heavily than others.  Thus, we W(Y(j)) = 1.  The log-rank test is the most powerful so it is the best choice.  However, this test is only the most powerful when the hazard rates are proportional to each other within populations.  For this reason, we stratify the model to identify its impacts and make sure no assumptions are violated.

What we see when we perform this stratification is a very large difference between someone without menopause and small cancer cells and someone who is menopausal and has very large cancer cells.  We also see that stratifying on age has the best fit.



\section{Modeling}


\subsection {Semi Parametric PH models}
For Semi Parametric Proportional Hazards Model, We proceed as follows:

The variable size is a categorical variable with 3 levels so we recode the levels 20-50 and >50 as binary variables and take the level <=20 as reference level. The same holds for the variable grade which has 2 levels. So the level grade=3 is coded as a new binary variable and grade=2 as reference level.

In the dataset, there are 609 ties between times until death consisting of 1376 subjects in total. Considering the existence of tied observations, Efron approximation for the likelihood function will be implemented while estimating the PH model.

Lastly, rtime and recur variables are excluded from the model since they are not the chosen event of interest. We then estimate the full semi parametric proportional hazard model.


```{r message=FALSE, warning=FALSE, include=FALSE}
library(KMsurv)
library(MASS)
###Count of Tied Observations
data %>% group_by(dtime)%>%summarise(count=n())%>%filter(count>1)%>%summarise(ties=n(),tied_observ=sum(count))

##fitting full model

fit_ph1 <-
  coxph(
    Surv(dtime, as.numeric(death)) ~ chemo + meno + hormon + as.factor(size) +
      age + as.factor(grade) + nodes + pgr + er,
    data = data, ties = "efron"
  )

##Backward variable selection based on p-value
anova(fit_ph1)
fit_ph2 <-
  coxph(
    Surv(dtime, as.numeric(death)) ~ chemo + meno + hormon + as.factor(size) +
      age + as.factor(grade) + nodes + pgr,
    data = data, ties = "efron"
  )
anova(fit_ph2)
fit_ph3<-coxph(Surv(dtime,as.numeric(death))~meno+hormon+as.factor(size)+age+as.factor(grade)+nodes +pgr, data=data,ties = "efron")
anova(fit_ph3)
#all variables in fit_ph3 is significant

#variable selection based on AIC
#stepAIC <- stepAIC(fit_ph1,direction="both")

#chosen model:Surv(dtime, death) ~ as.factor(size) + age + 
   # as.factor(grade) + nodes + pgr

fit_ph_aic= coxph(formula = Surv(dtime, as.numeric(death)) ~ as.factor(size) + age + 
    as.factor(grade) + nodes + pgr , data = data, ties = "efron")
summary(fit_ph_aic)

AIC = c(extractAIC(fit_ph_aic)[2], extractAIC(fit_ph3)[2])
names(AIC) = c("SelectionAIC","Backward Selection" )
###No huge difference in AIC
fit_ph_final <- fit_ph3
fit_ph_final$coefficients

```

For model selection with all covariates, we first apply backward selection procedure to the fitted full model. By excluding the covariate with the largest p-value based on Chi-Square statistics in each iteration, we ended up with the model "dtime,death~meno+hormon+size+ age+grade+nodes+pgr" where all covariates are statistically significant.
As an alternative we also run stepwise AIC selection in both direction which selecting the model with the lowest AIC among all possible combinations of models with one more or one less covariate in each iteration. It resulted the model with size, age, 
grade, nodes, pgr as variables. In order to decide which criteria should be used to choose the model, we approach from 2 different points. From a logical point of view, the model including hormonal treatment seems reasonable since it has an influence on both death time and censoring time of subjects as we explored in the exploratory data analysis part. If we compare AIC of both models, we see that there is no huge difference (18543 and 18546, respectively). So we decide to go with the model selected based on p-value since it includes hormon in exchange of acceptable increase in AIC.


```{r echo=FALSE, message=FALSE, warning=FALSE}
##CI for HR of size>50 vs size20-50
covmat<-vcov(fit_ph_final)
e<-exp(fit_ph_final$coefficients['as.factor(size)>50'])/exp(fit_ph_final$coefficients['as.factor(size)20-50'])
ub<-exp(fit_ph_final$coefficients['as.factor(size)>50']-fit_ph_final$coefficients['as.factor(size)20-50'] -qnorm(0.025)*sqrt(covmat['as.factor(size)>50','as.factor(size)>50']+covmat['as.factor(size)20-50','as.factor(size)20-50']-2*covmat['as.factor(size)20-50','as.factor(size)>50']))
lb<-exp(fit_ph_final$coefficients['as.factor(size)>50']-fit_ph_final$coefficients['as.factor(size)20-50'] +qnorm(0.025)*sqrt(covmat['as.factor(size)>50','as.factor(size)>50']+covmat['as.factor(size)20-50','as.factor(size)20-50']-2*covmat['as.factor(size)20-50','as.factor(size)>50']))
ci<-c(e,lb,ub)
names(ci)<-c("est","lb","ub")

###QUESTION: Do we have tied observations??

fit.ph.table <- summary(fit_ph_final)$conf[,c(1,3,4)]
fit.ph.table<-rbind(fit.ph.table,ci)
row.names(fit.ph.table)<-c("meno=1", "hormon=1", "size20-50", "size>50", "age i", "grade=3", "nodes i", "pgr i", "size>50")
reflev<-c("0", "0", "size>=20", "size>=20","age i-1", "grade=2", "nodes i-1", "pgr i-1", "size20-50")
fit.ph.table1<-cbind(reflev,fit.ph.table)
colnames(fit.ph.table1)<-c("vs Level","Relative Risks ($exp(\\hat{\\beta})$)","95% CI Lower Bound","95% CI Upper Bound")
kable(fit.ph.table1, 
      caption = "Relative Risks and CI for Every Pairs of Levels of Categorical Variables") %>%
kable_styling(font_size = 8, latex_options = c("striped", "hold_position"))
```

```{r relative-risks-tbl, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
relativeRisks.table <- function(model, digits = 3) {
  
  table <- round(summary(model)$conf.int[, -2], digits)
  label <- c("")
  
  # Add row names after the models have been fixed!
  rownames(table) <- c( "Meno", "Hormon", "Size (20-50)", "Size (>50)", 
                       "Age", "Grade = 3", "Nodes", "Pgr")
  colnames(table) <- c("$exp(\\hat{\\beta})$", "5\\%", "95\\%")

  table
}
-
kbl(relativeRisks.table(fit_ph_final), 
    escape = FALSE, booktabs = TRUE,
    caption = "Estimators and confidence intervals for relative risks under x model.") %>% kable_styling(font_size = 10, latex_options = c("striped", "hold_position"))
```

Estimation and CI of relative risks for every pair of levels of the
categorical variables are calculated and shown in the table above. With the aim of checking constant proportional hazard assumption, we run a statistical test based on Schoenfeld residuals for each covariate included in the fitted model with the null hypothesis of residuals being independent from time. From the output below, one can see that test is statistically highly significant for the covariates pgr and age with nodes and menopause being a borderline case. It shows that relative risks for categorical variables are constant over time while null hypothesis of constant hazard ratio is rejected for continuous variables. 

##The global test is also highly significant and the null hypothesis can be rejected. 
##So we can conclude that proportional hazard assumption of constant hazard ratio over time is violated since there is significant dependency between Schoenfeld residuals and time.
**??? Do you agree we should interpret the test outputs excluding cont variables as above since its stated in the project pdf that we are interested in relative risks for categorical variables or should we just look at global test and say that assumption is violated?**


```{r}
#Test for assumption of constant HR 
test <- cox.zph(fit_ph_final)$table
kbl(test, booktabs = T, caption = "Proportional Hazard Test") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


\subsection {Parametric Regression Models}

```{r}
library(KMsurv)
library(survival)
logn = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="lognormal")
weib = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="weibull")
expon = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="exponential")
loglogist = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="loglogistic")

AIC = c(extractAIC(logn)[2], extractAIC(weib)[2], extractAIC(expon)[2], extractAIC(loglogist)[2])
names(AIC) = c("log(normal)", "weibull", "exponential", "log(logistic)")
AIC <- as.data.frame(AIC)

kbl(AIC, booktabs = T, caption = "Parametric Model Evaluation") %>%
  kable_styling(latex_options = c("striped", "hold_position")) 

log.normal <- AIC["log(normal)",1]
```

We first evaluate parametric models based on variables already selected in the previous section.  Here we are comparing log (normal), weibull, exponential, and log (logistic) distributions.  This is done by using AIC and identifying if the additional parameters are worth it.  What we see is that the log(normal) distribution has the best AIC at `r log.normal`.  It should be noted that these AIC values can not be directly compared to the semi-parametric values.  We are able to estimate the linear coefficients to be the negative of the log(normal) coefficients due to the normality of this distribution.  These can be see in Table 12.

```{r CoefficientComparison}
# Linear model predictors
library(broom)

bestModel <- logn
tidyModel <- tidy(bestModel, type = 'text')
tidyModel <- head(tidyModel, nrow(tidyModel)-1)
linCoeffs <- c(-bestModel$coefficients)
tidyModel <- cbind(round(tidyModel[,2:(ncol(tidyModel)-1)], 2), tidyModel[,ncol(tidyModel)])
table <- cbind(tidyModel, round(confint(bestModel), 2), round(linCoeffs, 2))
colnames(table)[7] <- "Linear Coefficient"

kbl(table, booktabs = T, caption = "Parametric Model Coefficient Comparison") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


When we look at our categorical variable, hormon, it is significant and the confidence interval confirms this as it does not contain 0.  However, it should be noted that this is a borderline case.


<!-- # References -->

<!-- ::: {#refs} -->
<!-- ::: -->
