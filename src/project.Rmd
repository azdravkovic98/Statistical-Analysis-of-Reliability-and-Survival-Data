---
documentclass: article
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    extra_dependencies: ["float"]
    includes:
      in_header: preamble.sty
      before_body: titlepage.sty
    toc: false
---

```{r setup, include=FALSE}
options(knitr.kable.NA = '')
knitr::opts_chunk$set(echo = FALSE, fig.pos = "H", out.extra = "")
```

\section{Introduction}

The Rotterdam dataset consists of observations taken from 2982 patients diagnosed with breast cancer. Table \@ref(tab:data-desc) explains the covariates in the dataset.

In many medical studies, time to death is the event of interest. However, in cancer, another important measure is the time between response to treatment and recurrence or relapse-free survival time. It is important to state what the event is and when the period of observation starts and finishes. 

In this report we will analyze \textit{overall survival} - the time from date of curative surgery to the time of death. In our dataset censoring variable is variable \textit{death}, and the time variable is \textit{dtime}. Hence, recurrence variables \textit{recur}, and \textit{rtime} will be excluded in the further analysis.

In the Rotterdam dataset we encounter right censored data only. Right censoring arises largely from the fact that only some individuals have experienced the event and, subsequently, survival times will be unknown for a subset of the study group. This phenomenon may arise in the following ways: 

  * A patient has not (yet) experienced the relevant outcome, such as relapse or death, by the time of the close of the study.
  * A patient is lost to follow-up during the study period.
  * A patient experiences a different event that makes further follow-up impossible.


```{r message=FALSE, warning=FALSE}
library(survival)
data <- rotterdam

data$death <- as.factor(data$death)
data$meno <- as.factor(data$meno)
data$size <- as.factor(data$size)
data$grade <- as.factor(data$grade)
data$hormon <- as.factor(data$hormon)
data$chemo <- as.factor(data$chemo)
data$recur <- as.factor(data$recur)
```

```{r data-desc, echo=FALSE, message=FALSE, warning=FALSE, fig.pos="H"}
library(kableExtra)
library(glue)
table <- rbind(c("pid", "Patient identifier"), 
               c("year", "Year of surgery"),
               c("age", "Age at surgery"), 
               c("meno", "Menopausal status (0 = premenopausal, 1 = postmenopausal)"), 
               c("size", "Tumor size, a factor with levels <= 20, 20-25, > 50"), 
               c("grade", "Differentiation grade"), 
               c("nodes", "Number of positive lymph nodes"), 
               c("pgr", "Progesterone receptors (fmol/l)"), 
               c("er", "Estrogen receptors (fmol/l)"),
               c("hormon", "Hormonal treatment (0=no, 1=yes)"),
               c("chemo", "Chemotherapy"),
               c("rtime", "Days to relapse or last follow-up"),
               c("recur","0 = no relapse, 1 = relapse"),
               c("dtime","Days to death or last follow-up"),
               c("death","0 = alive, 1 = dead"))
kbl(table, booktabs = T, caption = "Data description") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

\newpage

\section{Exploratory Data Analysis} \label{EDA}

\subsection{Categorical Variables}

When we investigate the categorical variables, we see that some have a larger difference between time until death than others.  When we first investigate menopause, we see that menopausal patients are very similar in their death time.  A very similar pattern is observed for chemotherapy but the patients that did not die had a slightly higher time before leaving the study.  While size, having three levels, needs to be interpreted slightly differently.  With patients that died, the larger cancer cells certainly caused it to happen sooner.  This makes intuitive sense that more severe cancer would have more long term health risks.  Among patients that do not die, only the extremely large cancer patients had a much lower recurrence time.  While small and medium patients had a very similar response.  Grade had a very similar response among all patients with higher grade patients living slightly shorter lives.  Patients given hormonal therapy seem to have a smaller tail among patients that died; meaning those who relapse are more likely to do it soon after treatment.  Surviving patients that had hormonal therapy also appear to be censored more quickly than those who do not receive the treatment.

```{r boxPlots, include=TRUE, message = FALSE, fig.show = "hold", out.width = "50%"}
library(ggplot2)
menoBox <- ggplot(data, aes(x = death, y = dtime, fill=death, linetype=meno,colour=meno)) + geom_boxplot(lwd=0.75)+
theme_minimal()+
scale_fill_manual(values=c("darkolivegreen", "darkred")) + scale_colour_manual(values=c("black","black"))

chemoBox <- ggplot(data, aes(x = death, y = dtime, fill=death, linetype=chemo,colour=chemo)) + geom_boxplot(lwd=0.75)+
theme_minimal()+
scale_fill_manual(values=c("darkolivegreen", "darkred")) + scale_colour_manual(values=c("black","black"))

sizeBox <- ggplot(data, aes(x = death, y = dtime, fill=death, linetype=size,colour=size)) + geom_boxplot(lwd=0.75)+
theme_minimal()+
scale_fill_manual(values=c("darkolivegreen", "darkred")) + scale_colour_manual(values=c("black","black","black"))

gradeBox <- ggplot(data, aes(x = death, y = dtime, fill=death, linetype=grade,colour=grade)) + geom_boxplot(lwd=0.75)+
theme_minimal()+
scale_fill_manual(values=c("darkolivegreen", "darkred")) + scale_colour_manual(values=c("black","black"))

hormonBox <- ggplot(data, aes(x = death, y = dtime, fill=death, linetype=hormon,colour=hormon)) + geom_boxplot(lwd=0.75)+
theme_minimal()+
scale_fill_manual(values=c("darkolivegreen", "darkred")) + scale_colour_manual(values=c("black","black"))

plot(menoBox)
plot(chemoBox)
plot(sizeBox)
plot(gradeBox)
plot(hormonBox)
```

\subsection{Continuous Variables}

Among continuous variables, we first investigated age.  We plotted a both the lowess curve and the linear model to see if they match.  If so, they most likely have data with a limited skew and do not require transformation for modeling.  We first evaluated age and there was not a difference between the linear and lowess curves.  Next, we investigated the relationship between er and death time.  Here we see a large deviation which was corrected for again with a log transform.  Finally, we evaluated pgr and it had a good fit overall.



```{r scatterPlots, include=TRUE, message=FALSE, warning=FALSE, fig.show = "hold", out.width = "50%"}

# Basic age
ggplot(data, aes(x = age, y = dtime, color = death)) +
  geom_point() + geom_smooth(formula='y ~ x', method="loess",size=2, se=FALSE) + 
  geom_smooth(formula='y ~ x', method="lm",size=2, se=FALSE) +
  theme_minimal()+
  scale_color_manual(values=c("darkolivegreen", "darkred"))

# er
ggplot(data, aes(x = er, y = dtime, color = death)) +
  geom_point() + geom_smooth(formula='y ~ x', method="loess",size=2, se=FALSE) + 
  geom_smooth(formula='y ~ x', method="lm",size=2, se=FALSE) +
  theme_minimal()+
  scale_color_manual(values=c("darkolivegreen", "darkred"))

# log(er)
ggplot(data, aes(x = log(er), y = dtime, color = death)) +
  geom_point() + geom_smooth(formula='y ~ x', method="loess",size=2, se=FALSE) + 
  geom_smooth(formula='y ~ x', method="lm",size=2, se=FALSE) +
  theme_minimal()+
  scale_color_manual(values=c("darkolivegreen", "darkred"))

ggplot(data, aes(x = pgr, y = dtime, color = death)) +
  geom_point() + geom_smooth(formula='y ~ x', method="loess",size=2, se=FALSE) + 
  geom_smooth(formula='y ~ x', method="lm",size=2, se=FALSE) +
  theme_minimal()+
  scale_color_manual(values=c("darkolivegreen", "darkred"))
```

\newpage

\section{Further Analysis}

Now the focus will be on the response variable, the censoring indicator,
and the categorical variable.

\subsection{Survival Distrubution by Levels of \textit{Size}, \textit{Meno}, \textit{Hormon}, and \textit{Chemo}} \label{survival-distr}

For each of the levels of the categorical variables, we will compute the survival distribution and interpret the results.

The Kaplan-Meier curve illustrates the survival function. Itâ€™s a step function illustrating the cumulative survival probability over time. The curve is horizontal over periods where no event occurs, then drops vertically corresponding to a change in the survival function at each time an event occurs.

\subsubsection{Size}

```{r message=FALSE, warning=FALSE, include=FALSE}
fit.size <- survfit(Surv(dtime, as.numeric(death)) ~ size, data = data)
```

```{r message=FALSE, warning=FALSE, out.width = "65%", fig.align='center'}
#install.packages("survminer")
library(survminer)
ggsurvplot(fit.size,
           pval = TRUE, conf.int = TRUE,
           #risk.table = TRUE, # Add risk table
           #risk.table.col = "strata", # Change risk table color by groups
           linetype = "strata", # Change line type by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           palette = c("darkolivegreen", "darkred", "darkblue"), 
           data = data)
```

The horizontal axis represents time in days, and the vertical axis shows
the probability of surviving, or the proportion of people surviving. The
lines represent survival curves of the three groups. A vertical drop in
the curves indicates an event. The vertical tick mark on the curves
means that a patient was censored at this time.


```{r median-size, echo=FALSE, message=FALSE, warning=FALSE}
fit.size.table <- summary(fit.size)$table
rownames(fit.size.table) <- c("Size ($\\leq$20)", "Size (20$-$50)", "Size ($>$50)")
#colnames(fit.size.table) <- c()

kbl(fit.size.table, 
    escape = FALSE, booktabs = T,
    caption = "Summary of the model.") %>%
  kable_styling(font_size = 8, latex_options = c("striped", "hold_position"))
```

At time zero, the survival probability is 1.0 (or 100% of the participants are alive). E.g. on the day 4000, the probability of survival for patients whose cancer size exceeds 50 is approximately 25%, while the same probability for the patients with cancer size less than 20 stands around 62%. 

Table \@ref(tab:median-size) shows that median survival times for patients with cancer size smaller than 20, between 20 and 50, and greater that 50 is respectively: `r fit.size.table[, 'median'][1]`, `r fit.size.table[, 'median'][2]`, and `r fit.size.table[, 'median'][3]`. This suggests worse survival for patients with tumor of larger size. However, to evaluate whether this difference is statistically significant requires a formal statistical test, a subject that is discussed in the next sections.

The same conclusion can be made upon visual inspection of the Kaplan-Meier curve. 
The blue curve displaying survival probability of patients with cancer size greater than 50 is always below the curves representing other patient groups, once again indicating worse survival time for patients with larger tumors.

\subsubsection{Menopause}

```{r message=FALSE, warning=FALSE}
fit.meno <- survfit(Surv(dtime, as.numeric(death)) ~ meno, data = data)
```

```{r message=FALSE, warning=FALSE, out.width = "65%", fig.align='center'}
ggsurvplot(fit.meno,
           pval = TRUE, conf.int = TRUE,
           #risk.table = TRUE, # Add risk table
           #risk.table.col = "strata", # Change risk table color by groups
           linetype = "strata", # Change line type by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           palette = c("darkred", "darkolivegreen"), 
           data = data)
```

```{r median-meno, include=TRUE, message = FALSE}
fit.meno.table <- summary(fit.meno)$table
rownames(fit.meno.table) <- c("Meno = 0", "Meno = 1")
#colnames(fit.meno.table) <- c()

kbl(fit.meno.table, 
    escape = FALSE, booktabs = T,
    caption = "Median survival times for each group.") %>%
  kable_styling(font_size = 8, latex_options = c("striped", "hold_position"))
```


Table \@ref(tab:median-meno) shows that the median survival time is `r fit.meno.table[,'median'][1]` for non-menopausal patients, and `r fit.meno.table[,'median'][2]` for menopausal, suggesting worse survival for patients that have gone through
menopause.

\subsubsection{Hormonal Treatment}

```{r message=FALSE, warning=FALSE}
fit.hormon <- survfit(Surv(dtime, as.numeric(death)) ~ hormon, data = data)
```

```{r message=FALSE, warning=FALSE, out.width = "65%", fig.align='center'}
ggsurvplot(fit.hormon,
           pval = TRUE, conf.int = TRUE,
           #risk.table = TRUE, # Add risk table
           #risk.table.col = "strata", # Change risk table color by groups
           linetype = "strata", # Change line type by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           palette = c("darkred", "darkolivegreen"), 
           data = data)
```

```{r median-hormon, include=TRUE, message = FALSE}
fit.hormon.table <- summary(fit.hormon)$table
rownames(fit.hormon.table) <- c("Hormon = 0", "Hormon = 1")
#colnames(fit.meno.table) <- c()

kbl(fit.hormon.table, 
    escape = FALSE, booktabs = T,
    caption = "Median survival times for each group.") %>%
  kable_styling(font_size = 8, latex_options = c("striped", "hold_position"))

```

Table \@ref(tab:median-hormon) shows that the median survival time is `r fit.hormon.table[,'median'][1]` for patients that went through hormonal therapy, and `r fit.hormon.table[,'median'][2]` for those who did not, suggesting slightly worse survival for patients that have gone through the hormonal therapy. 

\subsubsection{Chemotherapy}

```{r message=FALSE, warning=FALSE}
fit.chemo <- survfit(Surv(dtime, as.numeric(death)) ~ chemo, type="kaplan-meier", data = data)
```


```{r message=FALSE, warning=FALSE, out.width = "65%", fig.align='center'}
ggsurvplot(fit.chemo,
           pval = TRUE, conf.int = TRUE,
           #risk.table = TRUE, # Add risk table
           #risk.table.col = "strata", # Change risk table color by groups
           linetype = "strata", # Change line type by groups
           surv.median.line = "hv", # Specify median survival
           ggtheme = theme_bw(), # Change ggplot2 theme
           palette = c("darkred", "darkolivegreen"), 
           data = data)
```

```{r median-chemo, include=TRUE, message = FALSE}
fit.chemo.table <- summary(fit.chemo)$table
rownames(fit.chemo.table) <- c("Chemo = 0", "Chemo = 1")
#colnames(fit.meno.table) <- c()

kbl(fit.chemo.table, 
    escape = FALSE, booktabs = T,
    caption = "Median survival times for each group.") %>%
  kable_styling(font_size = 8, latex_options = c("striped", "hold_position"))

```

Table \@ref(tab:median-chemo) shows that the median survival time is `r fit.hormon.table[,'median'][1]` for patients that went through chemotherapy, and `r fit.hormon.table[,'median'][2]` for those who did not, suggesting slightly better survival for patients that have gone through chemotherapy. 
The reason for this could be that chemotherapy is a very aggressive treatment that is detrimental to a patient's immune system. Due to aggressive nature of chemotherapy it is typically reserved for patients with severe cancer. This is a plausible reason why the patients that have gone through chemotherapy tend to have shorter lives overall. 

\subsection{Confidence Intervals and Estimators by Levels of \textit{Size}, \textit{Meno}, \textit{Hormon}, and \textit{Chemo}}

For each level we will obtain an appropriate estimator and confidence interval for the 3 quartiles of the survival curves and interpret the results.

```{r quantiles-size, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)

quantile.size <- quantile(fit.size, conf.int = TRUE)$quantile
quantile.size.lower <- quantile(fit.size, conf.int = TRUE)$lower
quantile.size.upper <- quantile(fit.size, conf.int = TRUE)$upper

quantile25 <- quantile.size[, "25"]
quantile25.lower <- quantile.size.lower[, "25"]
quantile25.upper <- quantile.size.upper[, "25"]

quantile50 <- quantile.size[, "50"]
quantile50.lower <- quantile.size.lower[, "50"]
quantile50.upper <- quantile.size.upper[, "50"]

quantile75 <- quantile.size[, "75"]
quantile75.lower <- quantile.size.lower[, "75"]
quantile75.upper <- quantile.size.upper[, "75"]

quantile.size.table <- data.frame(quantile25,
                                  quantile25.lower,
                                  quantile25.upper,
                                  quantile50,
                                  quantile50.lower,
                                  quantile50.upper,
                                  quantile75,
                                  quantile75.lower,
                                  quantile75.upper)
rownames(quantile.size.table) <- c("Size ($\\leq$20)" ,"Size (20$-$50)", "Size ($>$50)")
names(quantile.size.table)[1] <- "$\\hat{q_1}$"
names(quantile.size.table)[2] <- "5\\%"
names(quantile.size.table)[3] <- "95\\%"
names(quantile.size.table)[4] <- "$\\hat{q_2}$"
names(quantile.size.table)[5] <- "5\\%"
names(quantile.size.table)[6] <- "95\\%"
names(quantile.size.table)[7] <- "$\\hat{q_3}$"
names(quantile.size.table)[8] <- "5\\%"
names(quantile.size.table)[9] <- "95\\%"

```

```{r quantiles-meno, echo=FALSE, message=FALSE, warning=FALSE}
quantile.meno <- quantile(fit.meno, conf.int = TRUE)$quantile
quantile.meno.lower <- quantile(fit.meno, conf.int = TRUE)$lower
quantile.meno.upper <- quantile(fit.meno, conf.int = TRUE)$upper

quantile25 <- quantile.meno[, "25"]
quantile25.lower <- quantile.meno.lower[, "25"]
quantile25.upper <- quantile.meno.upper[, "25"]

quantile50 <- quantile.meno[, "50"]
quantile50.lower <- quantile.meno.lower[, "50"]
quantile50.upper <- quantile.meno.upper[, "50"]

quantile75 <- quantile.meno[, "75"]
quantile75.lower <- quantile.meno.lower[, "75"]
quantile75.upper <- quantile.meno.upper[, "75"]

quantile.meno.table <- data.frame(quantile25,
                                  quantile25.lower,
                                  quantile25.upper,
                                  quantile50,
                                  quantile50.lower,
                                  quantile50.upper,
                                  quantile75,
                                  quantile75.lower,
                                  quantile75.upper)
rownames(quantile.meno.table) <- c("Meno = 0" ,"Meno = 1")
names(quantile.meno.table)[1] <- "$\\hat{q_1}$"
names(quantile.meno.table)[2] <- "5\\%"
names(quantile.meno.table)[3] <- "95\\%"
names(quantile.meno.table)[4] <- "$\\hat{q_2}$"
names(quantile.meno.table)[5] <- "5\\%"
names(quantile.meno.table)[6] <- "95\\%"
names(quantile.meno.table)[7] <- "$\\hat{q_3}$"
names(quantile.meno.table)[8] <- "5\\%"
names(quantile.meno.table)[9] <- "95\\%"


```


```{r quantiles-hormon, echo=FALSE, message=FALSE, warning=FALSE}
quantile.hormon <- quantile(fit.hormon, conf.int = TRUE)$quantile
quantile.hormon.lower <- quantile(fit.hormon, conf.int = TRUE)$lower
quantile.hormon.upper <- quantile(fit.hormon, conf.int = TRUE)$upper

quantile25 <- quantile.hormon[, "25"]
quantile25.lower <- quantile.hormon.lower[, "25"]
quantile25.upper <- quantile.hormon.upper[, "25"]

quantile50 <- quantile.hormon[, "50"]
quantile50.lower <- quantile.hormon.lower[, "50"]
quantile50.upper <- quantile.hormon.upper[, "50"]

quantile75 <- quantile.hormon[, "75"]
quantile75.lower <- quantile.hormon.lower[, "75"]
quantile75.upper <- quantile.hormon.upper[, "75"]

quantile.hormon.table <- data.frame(quantile25,
                                  quantile25.lower,
                                  quantile25.upper,
                                  quantile50,
                                  quantile50.lower,
                                  quantile50.upper,
                                  quantile75,
                                  quantile75.lower,
                                  quantile75.upper)
rownames(quantile.hormon.table) <- c("Hormon = 0" ,"Hormon = 1")
names(quantile.hormon.table)[1] <- "$\\hat{q_1}$"
names(quantile.hormon.table)[2] <- "5\\%"
names(quantile.hormon.table)[3] <- "95\\%"
names(quantile.hormon.table)[4] <- "$\\hat{q_2}$"
names(quantile.hormon.table)[5] <- "5\\%"
names(quantile.hormon.table)[6] <- "95\\%"
names(quantile.hormon.table)[7] <- "$\\hat{q_3}$"
names(quantile.hormon.table)[8] <- "5\\%"
names(quantile.hormon.table)[9] <- "95\\%"


```


```{r quantiles-chemo, echo=FALSE, message=FALSE, warning=FALSE, fig.pos="H"}
quantile.chemo <- quantile(fit.chemo, conf.int = TRUE)$quantile
quantile.chemo.lower <- quantile(fit.chemo, conf.int = TRUE)$lower
quantile.chemo.upper <- quantile(fit.chemo, conf.int = TRUE)$upper

quantile25 <- quantile.chemo[, "25"]
quantile25.lower <- quantile.chemo.lower[, "25"]
quantile25.upper <- quantile.chemo.upper[, "25"]

quantile50 <- quantile.chemo[, "50"]
quantile50.lower <- quantile.chemo.lower[, "50"]
quantile50.upper <- quantile.chemo.upper[, "50"]

quantile75 <- quantile.chemo[, "75"]
quantile75.lower <- quantile.chemo.lower[, "75"]
quantile75.upper <- quantile.chemo.upper[, "75"]

quantile.chemo.table <- data.frame(quantile25,
                                  quantile25.lower,
                                  quantile25.upper,
                                  quantile50,
                                  quantile50.lower,
                                  quantile50.upper,
                                  quantile75,
                                  quantile75.lower,
                                  quantile75.upper)
rownames(quantile.chemo.table) <- c("Chemo = 0" ,"Chemo = 1")
names(quantile.chemo.table)[1] <- "$\\hat{q_1}$"
names(quantile.chemo.table)[2] <- "5\\%"
names(quantile.chemo.table)[3] <- "95\\%"
names(quantile.chemo.table)[4] <- "$\\hat{q_2}$"
names(quantile.chemo.table)[5] <- "5\\%"
names(quantile.chemo.table)[6] <- "95\\%"
names(quantile.chemo.table)[7] <- "$\\hat{q_3}$"
names(quantile.chemo.table)[8] <- "5\\%"
names(quantile.chemo.table)[9] <- "95\\%"


table <- rbind(quantile.size.table,
               quantile.chemo.table,
               quantile.meno.table,
               quantile.hormon.table)
table <- round(table)
quantile.chemo.table[is.na(quantile.chemo.table)] <- "$\\textit{NA}$"
quantile.size.table[is.na(quantile.size.table)] <- "$\\textit{NA}$"
quantile.hormon.table[is.na(quantile.hormon.table)] <- "$\\textit{NA}$"
quantile.meno.table[is.na(quantile.meno.table)] <- "$\\textit{NA}$"
table[is.na(table)] <- "$\\textit{NA}$"

kbl(table,
    escape = FALSE, booktabs = T,
    caption = "Estimates and confidence intervals for 3 quartiles for each level of covariates $\\textit{size, chemo, meno, hormon}$.") %>%
  kable_styling(font_size = 10, latex_options = c("striped", "hold_position"))
```



We first evaluate \textit{size} and see similar results to what was observed in the EDA bar charts. We see that at the 25th percentile, Size > 50 has a very significant difference from the other two groups.  With this being significantly smaller, their \textit{dtime} is significantly smaller.  This intuitively makes sense that a person who has larger cancer would have a worse life expectancy. 


When we investigate the effect of menopause on survival, we see that generally people that are menopausal have lower survival times.  This is supported by that at the 25th, and 50th percentiles, there is no overlap in the quantiles' confidence intervals.  This means that up until 75th percentile, a menopausal person would have a shorter life. However, this could be due to other covariates such as the fact that all menopausal people are women or that they tend to be older. After the 3rd quantile, we lose information about patients in the non-menopausal group. 


We next evaluate the effect of hormonal treatment.  We see here that those who received hormonal treatment generally have a lower survival time.  We also see that there is no overlap between the confidence intervals indicating that not only did they have a large difference, but it sustained itself up until the 75th percentile, when we loose information on the group that did not go through the treatment.


Finally, we evaluate the effect of chemotherapy.  Here we see that generally chemotherapy patients live shorter.  However, this only becomes significant at the 75th percentile.  This means that generally patients that receive chemotherapy are not significantly affected until they live for a long time.

Note that if one of the groups has not yet dropped to 50% survival at the end of the available data, we cannot compute a median survival and there will be NA values for median survival in such cases. The same holds for other quantiles. 


\subsection{Test of Differences Between the Survival Curves}


In this setting we chose to use the log-rank test.  This is because we do not want to weight any observations more heavily than others.  The log-rank test is the most powerful so it is the best choice.  However, this test is only the most powerful when the hazard rates are proportional to each other within populations.  For this reason, we stratify the subjects, and perform  stratified log-rank test in order to obtain an overall assessment of the difference between survival curves, by combining information over the different strata to gain power.

In Section \@ref(survival-distr) we observed differences between survival curves by levels of different categorical variables. In this section, we will also evaluate whether this difference is statistically significant using a formal statistical test - the stratified log-rank test.

We focus on covariate \textit{meno}, and stratify by \textit{chemo}, \textit{size}, and \textit{hormon}.

We observe significant differences between survival curves of each level of variable \textit{meno} after conducting the stratified test (see Table \@ref(tab:stratify)), indicating that menopausal status is an important factor in survival time for breast cancer patients.

```{r stratify, echo=FALSE, message=FALSE, warning=FALSE}
# Stratification by size
stratify.size <- survdiff(Surv(dtime, as.numeric(death)) ~ meno + strata(size), 
                          data = data)

chisq.size <- stratify.size$chisq
df.size <- length(stratify.size$n) - 1
p.size <- 1 - pchisq(stratify.size$chisq, 
                     length(stratify.size$n) - 1)
by.size <- c(round(chisq.size, 2), round(df.size), round(p.size, 5))

# Stratification by chemo
stratify.chemo <- survdiff(Surv(dtime, as.numeric(death)) ~ meno + strata(chemo), 
                          data = data)

chisq.chemo <- stratify.chemo$chisq
df.chemo <- length(stratify.chemo$n) - 1
p.chemo <- 1 - pchisq(stratify.chemo$chisq, 
                    length(stratify.chemo$n) - 1)
by.chemo <- c(round(chisq.chemo, 2), round(df.chemo), round(p.chemo, 5))


# Stratification by hormon
stratify.hormon <- 
  survdiff(Surv(dtime, as.numeric(death)) ~ meno + strata(hormon), 
           data = data)

chisq.hormon <- round(stratify.hormon$chisq, 3)
df.hormon <- round(length(stratify.hormon$n) - 1)
p.hormon <- round(1 - pchisq(stratify.hormon$chisq, 
                       length(stratify.hormon$n) - 1), 4)
by.hormon <- c(chisq.hormon, df.hormon, p.hormon)

table <- rbind(by.chemo, by.size, by.hormon)
rownames(table) <- c("Stratified by Chemo", 
                     "Stratified by Size", 
                     "Stratified by Hormon")
colnames(table) <- c("$\\chi^2$", "df", "p-value")

kbl(table, 
    escape = FALSE, booktabs = T,
    caption = "Stratified log-rank test for differences in menopause.") %>%
  kable_styling(font_size = 10, latex_options = c("striped", "hold_position"))

```

```{r message=FALSE, warning=FALSE, include=FALSE}
stratify.size.fit <- survfit(Surv(dtime, as.numeric(death)) ~ meno + strata(size), 
                             data = data,
                             type="kaplan-meier", 
                             conf.type="log-log")
```


```{r stratify-size-plot, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "Independent variable meno stratified by size of the tumor.", fig.pos="H", out.width = "85%", fig.align='center'}
ggsurvplot(stratify.size.fit,       # survfit object with calculated statistics.
           pval = TRUE,             # show p-value of log-rank test.
           conf.int = TRUE,        # show confidence intervals for point estimates of survival curves.
           conf.int.style = "step",  # customize style of confidence intervals
           xlab = "Time in days",   # customize X axis label.
           break.time.by = 1500,     # break X axis in time intervals by ...
           ggtheme = theme_bw(), # Change ggplot2 theme
           palette = c("darkred", "darkolivegreen", "darkcyan", "darkgoldenrod", "darkorange", "darkorchid"),
           surv.median.line = "hv",  # add the median survival pointer.
           #palette = c("#E7B800", "#2E9FDF", "maroon2"), # custom color palettes.
           data = data,
           xlim = c(0, 6500))
```



What we see in Figure \@ref(fig:stratify-size-plot) when we perform this stratification by the size of the breast cancer, is a very large difference between someone who has not gone through menopause and has small cancer cells, and someone who is menopausal and has very large cancer cells.


\newpage

\section{Modeling}

\subsection {Semiparametric Proportional Hazards Model} \label{semipar-ph-models}

For semiparametric proportional hazards model, we proceed as follows:

The variable \textit{size} is a categorical variable with 3 levels. We recode the levels Size ($20-50$) and Size ($>50$) as binary variables, and take the level Size ($\leq20$) as reference level. The same holds for the variable \textit{grade}, which has 2 levels. The level Grade = 3 is coded as a new binary variable, with Grade = 2 being the reference level.

In the dataset, there are 609 ties between times until death, consisting of 1376 subjects in total. Considering the existence of tied observations, Efron approximation for the likelihood function will be implemented while estimating the PH model.

Lastly, when estimating the full model, variables \textit{rtime} and \textit{recur} are excluded, since they are not the chosen event of interest. We then estimate the full semiparametric proportional hazard model.

```{r message=FALSE, warning=FALSE, include=FALSE}
library(KMsurv)
library(MASS)
library(dplyr)

###Count of Tied Observations
data %>% group_by(dtime)%>%summarise(count=n())%>%filter(count>1)%>%summarise(ties=n(),tied_observ=sum(count))

##fitting full model

fit_ph1 <-
  coxph(
    Surv(dtime, as.numeric(death)) ~ chemo + meno + hormon + as.factor(size) +
      age + as.factor(grade) + nodes + pgr + er,
    data = data, ties = "efron"
  )

##Backward variable selection based on p-value
anova(fit_ph1)
fit_ph2 <-
  coxph(
    Surv(dtime, as.numeric(death)) ~ chemo + meno + hormon + as.factor(size) +
      age + as.factor(grade) + nodes + pgr,
    data = data, ties = "efron"
  )
anova(fit_ph2)
fit_ph3 <-
  coxph(
    Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age +
      as.factor(grade) + nodes + pgr,
    data = data,
    ties = "efron"
  )
anova(fit_ph3)
#all variables in fit_ph3 is significant

#variable selection based on AIC
#stepAIC <- stepAIC(fit_ph1,direction="both")

#chosen model:Surv(dtime, death) ~ as.factor(size) + age +
# as.factor(grade) + nodes + pgr

fit_ph_aic = coxph(
  formula = Surv(dtime, as.numeric(death)) ~ as.factor(size) + age +
    as.factor(grade) + nodes + pgr ,
  data = data,
  ties = "efron"
)
summary(fit_ph_aic)

AIC = c(extractAIC(fit_ph_aic)[2], extractAIC(fit_ph3)[2])
names(AIC) = c("AIC Selection", "Backward Selection")
###No huge difference in AIC
fit_ph_final <- fit_ph3

```

```{r AIC-table, echo=FALSE, message=FALSE, warning=FALSE}
AIC.table <- rbind(AIC)
rownames(AIC.table) <- "AIC"

kbl(AIC.table, 
    escape = FALSE, booktabs = T,
    caption = "AIC Values for Models Selected by Stepwise AIC Procedure, and Backward Selection Procedure") %>%
  kable_styling(font_size = 10, latex_options = c("striped", "hold_position"))
```

For model selection with all covariates, we first apply backward selection procedure to the fitted full model. By excluding the covariate with the largest p-value based on $\chi^2$ statistics in each iteration, we ended up with the model where significant covariates are \textit{size, age, grade, nodes, pgr, meno, hormon}.

As an alternative model selection procedure, we run stepwise AIC selection in both directions, which compares models consisted of all possible combinations of covariates, and selects the one with the lowest AIC value. This resulted with the model where significant covariates are \textit{size, age, grade, nodes, pgr}. 

To decide which procedure should be used to choose the model, we approach from 2 different points. 
From a logical point of view, the model including variable \textit{hormon} seems reasonable, since hormonal treatment has an influence on both death time and censoring time of subjects, as we have seen in Section \@ref(EDA). 
On the other side, if we compare AIC of both models, from Table \@ref(tab:AIC-table) we see that there is no big difference between the two models (`r round(AIC[1])` and `r round(AIC[2])`, respectively). That is why we decide to use the model selected by the backward selection procedure, as it includes variable \textit{hormon} in exchange of acceptable increase in AIC.

```{r echo=FALSE, message=FALSE, warning=FALSE}
table <- cbind(fit_ph_final$coefficients)
colnames(table) <- "$\\hat{\\beta}$"
rownames(table) <- c("Meno = 1",
                     "Hormon = 1",
                     "Size (20-50)",
                     "Size (>50)",
                     "Age",
                     "Grade = 3",
                     "Nodes",
                     "Pgr")
kbl(table, 
    escape = FALSE, booktabs = TRUE,
    caption = "Estimated Coefficients of Covariates Under the Selected Model") %>% kable_styling(font_size = 10, latex_options = c("striped", "hold_position"))
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
## CI for HR of size>50 vs size20-50
covmat <- vcov(fit_ph_final)
e <-
  exp(fit_ph_final$coefficients['as.factor(size)>50']) / exp(fit_ph_final$coefficients['as.factor(size)20-50'])
ub <-
  exp(
    fit_ph_final$coefficients['as.factor(size)>50'] - fit_ph_final$coefficients['as.factor(size)20-50'] -
      qnorm(0.025) * sqrt(covmat['as.factor(size)>50', 'as.factor(size)>50'] +
                            covmat['as.factor(size)20-50', 'as.factor(size)20-50'] - 2 * covmat['as.factor(size)20-50', 'as.factor(size)>50'])
  )
lb <-
  exp(
    fit_ph_final$coefficients['as.factor(size)>50'] - fit_ph_final$coefficients['as.factor(size)20-50'] +
      qnorm(0.025) * sqrt(covmat['as.factor(size)>50', 'as.factor(size)>50'] +
                            covmat['as.factor(size)20-50', 'as.factor(size)20-50'] - 2 * covmat['as.factor(size)20-50', 'as.factor(size)>50'])
  )
ci <- c(e, lb, ub)
names(ci) <- c("est", "lb", "ub")
```


```{r relative-risks-tbl, echo=FALSE, message=FALSE, warning=FALSE}
model <- fit_ph_final
table <- round(summary(model)$conf.int[, -2], 3)
label <- c("")
table <- rbind(table, ci)
# Add row names after the models have been fixed!
rownames(table) <- c("Meno = 1 vs Meno = 0",
                     "Hormon = 1 vs Hormon = 0",
                     "Size $20-50$ vs Size $\\leq$ 20",                              
                     "Size $>$ 50 vs Size $\\leq$ 20",
                     "Age = i vs Age = i - 1",
                     "Grade = 3 vs Grade = 2",
                     "Nodes = i vs Nodes = i - 1",
                     "Pgr = i vs Pgr = i - 1",
                     "Size $>$50 vs Size $20-50$")
colnames(table) <- c("$exp(\\hat{\\beta})$", "5\\%", "95\\%")

kbl(table, 
    escape = FALSE, booktabs = TRUE,
    caption = "Relative risks and CI for each covariate") %>% 
  kable_styling(font_size = 10, latex_options = c("striped", "hold_position"))
```

Estimation and CI of relative risks for every pair of levels of the
categorical variables are calculated and shown in the Table \@ref(tab:relative-risks-tbl). 


```{r PH-test, echo=FALSE, message=FALSE, warning=FALSE}
#Test for assumption of constant HR 
test <- cox.zph(fit_ph_final)$table
colnames(test) <- c("$\\chi^2$",
                    "df",
                    "p-value")
rownames(test) <- c("Meno",
                     "Hormon",
                     "Size",
                     "Age",
                     "Grade",
                     "Nodes",
                     "Pgr", 
                     "GLOBAL")
kbl(round(test, 4), booktabs = T, escape = FALSE, caption = "Proportional Hazard Test") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```



With the purpose of checking constant proportional hazard assumption, we run a statistical test based on Schoenfeld residuals for each covariate included in the fitted model with the null hypothesis of residuals being independent from time. From the Table \@ref(tab:PH-test), one can see that test is statistically highly significant for the covariates pgr and age with nodes and menopause being a borderline case. It shows that relative risks for categorical variables are constant over time while null hypothesis of constant hazard ratio is rejected for continuous variables. 

##The global test is also highly significant and the null hypothesis can be rejected. 
##So we can conclude that proportional hazard assumption of constant hazard ratio over time is violated since there is significant dependency between Schoenfeld residuals and time.
**??? Do you agree we should interpret the test outputs excluding cont variables as above since its stated in the project pdf that we are interested in relative risks for categorical variables or should we just look at global test and say that assumption is violated?**



```{r eval=FALSE, fig.show="hold", message=FALSE, warning=FALSE, include=FALSE, out.width="80%"}
library(survival)
library(cowplot)
plot(cox.zph(fit_ph_final), resid = F, hr=T, col=1,lwd=1.5)
```

\subsection {Parametric Regression Models}

```{r param-models, echo=FALSE, message=FALSE, warning=FALSE}
library(KMsurv)
library(survival)
logn = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="lognormal")
weib = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="weibull")
expon = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="exponential")
loglogist = survreg(Surv(dtime, as.numeric(death)) ~ meno + hormon + as.factor(size) + age + as.factor(grade) + nodes + pgr, data=data, dist="loglogistic")

AIC = c(extractAIC(logn)[2], extractAIC(weib)[2], extractAIC(expon)[2], extractAIC(loglogist)[2])
names(AIC) = c("log(normal)", "weibull", "exponential", "log(logistic)")
AIC <- as.data.frame(AIC)

kbl(AIC, booktabs = T, caption = "Parametric Model Evaluation") %>%
  kable_styling(latex_options = c("striped", "hold_position")) 

log.normal <- AIC["log(normal)",1]
```

We first evaluate parametric models based on variables already selected in the Section \@ref(semipar-ph-models).  Here we are comparing log-normal, Weibull, exponential, and
log-logistic AFT models. This is done by using AIC selection, and identifying if the additional parameters are worth it.  What we see is that the log-normal model has the best AIC at `r log.normal`.  It should be noted that these AIC values can not be directly compared to the semiparametric values.  

The parametric models considered here have two representations:

  * Accelerated failure time model (AFT)
  * Linear model

Table \@ref(tab:param-models) shows point and interval estimates of the coefficient of variables both in the log-normal AFT model, and in the linear representation of the log-normal model.
We are able to estimate the linear coefficients of the log-normal model due to the normality of it's error distribution.

```{r CoefficientComparison}
# Linear model predictors
library(broom)

bestModel <- logn
tidyModel <- tidy(bestModel, type = 'text')
tidyModel <- head(tidyModel, nrow(tidyModel)-1)
linCoeffs <- c(-bestModel$coefficients)
tidyModel <- cbind(round(tidyModel[,2:(ncol(tidyModel)-1)], 2), tidyModel[,ncol(tidyModel)])
table <- cbind(tidyModel, round(confint(bestModel), 2), round(linCoeffs, 2))
colnames(table)[7] <- "Linear Coefficient"
rownames(table) <- c("(Intercept)",
                     "Meno = 1",
                     "Hormon = 1",
                     "Size (20-50)",
                     "Size (>50)",
                     "Age",
                     "Grade = 3",
                     "Nodes",
                     "Pgr")
kbl(table, booktabs = T, caption = "Parametric Model Coefficient Comparison") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


When we look at our categorical variable \textit{hormon}, we can see that it is significant. However, the significance is borderline.

